# ML System Design Doc - [RU]

## Прогнозирование спроса для сети супермаркетов MVP

### 1. Цели и предпосылки 

#### 1.1. Зачем идем в разработку продукта?  

- Бизнес-цель:
	- Оптимизировать управление товарными запасами и логистикой за счет точного прогнозирования спроса для каждой точки продаж, снизить потери из-за избыточных и дефицитных запасов, увеличить выручку
- Почему станет лучше, чем сейчас, от использования ML:
	- Отказ от интуитивного планирования заказов приведет к снижению количества ситуаций дефицита/избытка, а следовательно вырастет прибыль.
    - ML-модели смогут учитывать сезонность, тренды и региона точки.
- Что будем считать успехом итерации с точки зрения бизнеса:
	- Процент просроченных товаров уменьшился на 20%
	- Дефицит уменьшился на 15%

#### 1.2. Бизнес-требования и ограничения  

- Краткое описание БТ и ссылки на детальные документы с бизнес-требованиями:
	- Прогноз спроса на 14 дней вперед
	- Гранулярность: SKU × магазин × день
	- Обновление прогноза — ежедневно
	- Интеграция с системой заказов (через API)
	- Интерфейс отчетности для менеджеров
- Бизнес-ограничения: 
	- Нельзя увеличивать штат
	- Ограниченный бюджет на вычисления
	- Ограниченный доступ к облачным сервисам
- Что мы ожидаем от конкретной итерации: 
	- В этой итерации мы проверяем возможность автоматизированного прогноза спроса на уровне SKU × магазин с горизонтом 14 дней, и интегрируем его в реальный процесс принятия решений на ограниченной группе магазинов и товаров. Были определены следующие цели интеграции:
		- Получить работающий MVP-прогноз, сравнимый по качеству или лучше, чем прогнозы менеджеров
		- Проверить пригодность данных, их достаточность и стабильность
		- Протестировать процесс ежедневного обновления прогноза и передачи результата в ERP-систему
		- Проверить реакцию и восприятие бизнес-пользователей (менеджеров) на прогнозы от модели
		- Провести сравнительный анализ (A/B-группы) и подтвердить бизнес-эффект
- Описание бизнес-процесса пилота, насколько это возможно - как именно мы будем использовать модель в существующем бизнес-процессе?    
	- Сейчас менеджеры вручную формируют заявки на закупку товаров, опираясь на интуицию, сезон и прошлый опыт. Заказы передаются в ERP-систему, оттуда — на склады и поставки. Как будет работать во время пилота:
      	- Модель ежедневно прогнозирует продажи на 14 дней вперёд по каждому товару
      	- Результат прогнозов выгружается через API
        - Менеджеры в пилотных магазинах получают рекомендованный заказ, основанный на прогнозе (например: прогноз + safety stock – остатки)
        - Человеческая корректировка возможна, но сравниваем: что заказано по прогнозу, что заказано по ручной корректировке
        - Далее идет стандартный процесс — поставка, продажа, мониторинг остатков
        - После 2 недель сбора данных — сравниваем реальный спрос с прогнозом, и с заказом, оформленным вручную и по ML
- Что считаем успешным пилотом? Критерии успеха и возможные пути развития проекта:
	
| Метрика                  | Целевое значение                          | Обоснование                               |
| ------------------------ | ----------------------------------------- | ----------------------------------------- |
| Снижение излишков        | -20% по сравнению с контрольной           | Меньше списаний товаров с коротким сроком |
| Снижение дефицита        | -15%                                      | Меньше out-of-stock ситуаций              |
| WAPE прогноза            | ≤ 50% по 80% SKU                          | Прогноз достаточно точный                 |
| Приемлемость прогноза    | ≥ 70% менеджеров считают прогноз полезным | Анкетирование после пилота                |
| Доля предсказанных пиков | ≥ 60%                                     | Прогноз не пропускает резкие скачки       |

- Возможные пути развития проекта:
    - Расширение на всю сеть: 500 магазинов × 10,000 SKU
    - Автоматическое формирование заказов (без участия менеджера)
    - Учет внешних факторов (погода, праздники, акции)
    - Рекомендательная система по оптимизации запасов (optimizer поверх прогноза)
    - Перевод моделей на online-learning / auto-retraining

#### 1.3. Что входит в скоуп проекта/итерации, что не входит   

- На закрытие каких БТ подписываемся в данной итерации:
	- Прогноз продаж на горизонте 14 дней вперёд для уровня гранулярности SKU × магазин × день
	- Ежедневный пересчёт прогноза и выгрузка результата в API
	- Построение MVP-модели с адекватной точностью (WAPE ≤ 50% по 80% SKU в пилоте)
	- Подготовка витрин данных и реализация пайплайна модели
	- Интеграция с интерфейсом для менеджеров пилотных магазинов
	- Проведение A/B-теста с участием менеджеров
- Что не будет закрыто:
    - Учёт внешних факторов (погода, акции, праздники), будет отложено до следующих итераций
    - Обучение онлайн и auto-retrain моделей 
    - Полноценная интеграция в ERP-систему всей сети 
    - Полная автоматизация процесса заказа, пока только рекомендации
    - Обработка новых товаров, пока предполагаем наличие исторических данных
- Описание результата с точки зрения качества кода и воспроизводимости решения:
	- Код написан с учетом возможности расширения, включает конфигурируемые параметры модели, расширяемую архитектуру моделей
	- Используются unit-тесты для ключевых компонентов
    - Для моделей и результатов прогнозирования ведётся управление версиями
    - Документация на пайплайн, модели, формат данных и API-интерфейсы
- Описание планируемого технического долга (что оставляем для дальнейшей продуктивизации):
    - Упрощенная предобработка данных, пока без полной нормализации категориальных фичей
    - Использование одной модели на все магазины и товары без кластеризации и сегментации
    - MVP-модель пока не настроена на быструю работу при прогнозировании
	- Функция замены прогноза в случае ошибки пока не реализована

#### 1.4. Предпосылки решения  

| Блок          | Предпосылка                                                                    | Обоснование                                                   |
|---------------|--------------------------------------------------------------------------------| ------------------------------------------------------------- |
| Данные        | Используем исторические данные продаж по SKU × магазин × день за последний год | Достаточный период для учёта сезонности и трендов             |
| Гранулярность | SKU × магазин × день                                                           | Соответствует уровню принятия решений и точности заказов      |
| Горизонт      | Прогноз на 14 дней вперёд                                                      | Обоснован логистическим циклом и бизнес-требованиями          |
| Обновление    | Ежедневный пересчёт                                                            | Позволяет учитывать новые данные и адаптироваться к трендам   |
| Метрика       | Продажи в штуках (или литрах/килограммах — в зависимости от категории SKU)     | Единицы измерения, по которым происходит заказ и доставка     |
| Стратегия     | Прогнозирование с использованием отдельных моделей или кластеров SKU           | Обосновано различием поведения категорий товаров              |
| Ограничения   | Ограниченные вычислительные ресурсы и доступ к облакам                         | Будет использоваться on-premise решение или минимальный клауд |

### 2. Методология   

#### 2.1. Постановка задачи  

- **Тип задачи:** прогнозирование временных рядов на уровне SKU × магазин × день
- **Цель:** построить модель, которая на горизонте 14 дней будет выдавать прогноз спроса по каждому товару и каждой торговой точке
- **Ключевые компоненты решения:** подготовка и чистка данных, инженерия признаков, выбор и обучение моделей, валидация, управление версиями, метрики качества

#### 2.2. Блок-схема решения  

- СХЕМА ТУТ !!!!!!

#### 2.3. Этапы решения задачи 

- И ЧТО-ТО НЕПОНЯТНОЕ ЕЩЕ ЗДЕСЬ !!!!!!

### 3. Подготовка пилота  
  
#### 3.1. Способ оценки пилота  

- Выбираем 20 магазинов × 500 SKU
- A/B-группа:
    - A: менеджеры работают по старому (ручной заказ)
    - B: получают рекомендации модели

#### 3.2. Что считаем успешным пилотом  

- WAPE модели в группе B < WAPE в A
- На 15% меньше out-of-stock ситуаций
- Визуальный отчет, подтверждающий бизнес-выгоду

#### 3.3. Подготовка пилота
  
- Развернуть сервиc, настроить ежедневный запуск и интеграцию с интерфейсом
- Провести краткий вебинар по работе с рекомендациями модели и сбору обратной связи
- Ежедневно сохранять прогнозы, сформированные заказы, фактические продажи и остатки
- Обеспечить техподдержку на время пилота, отслеживать корректность работы пайплайна
- Анкета для менеджеров после 2 недель работы
- По завершении пилота собрать и проанализировать метрики, сформировать отчёт и рекомендации по дальнейшим шагам

### 4. Внедрение  

#### 4.1. Архитектура решения   
  
- БЛОК СХЕМА ТУТ !!!!!!  
  
#### 4.2. Описание инфраструктуры и масштабируемости 
  
- Какая инфраструктура выбрана:
    - **Kubernetes-кластер** для оркестрации контейнеров всех сервисов.
	- **Docker-контейнеры:**
        - Web-приложение для менеджеров (React + Node.js)
        - API-слой прогноза (Python + Flask)
        - Модель (Python + TensorFlow)
    - **Хранилища данных:**
        - PostgreSQL для транзакционных и оперативных данных о продажах 
        - DWH (Amazon Redshift / Google BigQuery / Snowflake) для исторических витрин

- Плюсы и минусы выбора:

| Технология                 | Плюсы                                                                                           | Минусы                                                   |
|----------------------------| ----------------------------------------------------------------------------------------------- | -------------------------------------------------------- |
| **Kubernetes**             | • Низкая латентность между сервисами и локальным хранилищем<br>• Полный контроль и безопасность | • Необходима внутренняя поддержка и обновление кластера  |
| **Docker-контейнеризация** | • Повторяемость окружений<br>• Быстрый rollout и rollback<br>• Изоляция зависимостей            | • Дополнительный слой сложности (надстройка и CI/CD)     |
| **Облачный DWH**           | • Практически неограниченный объём хранения<br>• Высокая скорость агрегаций для отчётов         | • Затраты на хранение и запросы в облаке                 |

- Почему финальный выбор лучше других альтернатив:
    - Контейнеры в Kubernetes обеспечивают повторяемость и изолированность сервисов, что упрощает CI/CD и rollback
    - Облачный DWH дает баланс стоимости и производительности: ядро аналитики в облаке, оперативные сервисы рядом с данными 
    - При росте нагрузки достаточно добавить ноды или включить облачный burst — минимальные изменения в архитектуре
  
#### 4.3. Требования к работе системы  
  
- **SLA:** 99% успешных ежедневных запусков
- **Пропускная способность:** 10.000 прогнозных точек в минуту
- **Задержка:** ≤ 1с на запрос SKU × магазин
  
#### 4.4. Безопасность системы  
  
- **Аутентификация:** JWT‑токены
- **Изоляция:** Kubernetes + лимиты ресурсов  
  
#### 4.5. Безопасность данных   

- **Шифрование данных:** все данные шифруются как при хранении, так и при передаче по сети
- **Дополнительная защита:** анонимизация персональных данных, соответсвие GDPR
  
#### 4.6. Издержки  
  
- **Бюджет:** 2.000 USD/мес (серверы + БД)
- **Хранение:** 100 GB прогнозов ≈ 20 USD/мес
  
#### 4.5. Точки интеграции
  
- **API-запрос:**
```
POST /recommendations

Headers:
Authorization: Bearer <TOKEN>
Content-Type: application/json

Request:
{
    "sku_id": 1,                                // id товара в БД
    "store_id": 2,                              // id магазина в БД
    "start_date": "30.05.2025",                 // день начала рекомандаций
    "end_date": "03.06.2025"                    // день конца рекомандаций (проверка на лимит 14 дней)
}

Response:
{
    "recommendation": [100, 209, 120, 23, 106]  // количество товара на каждый день
}
```
  
#### 4.6. Риски  

- Сбой передачи данных → отсутствие новых прогнозов
- Сбой сервиса → задержка рекомендаций
- Рост нагрузки → падение SLA